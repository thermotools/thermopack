cmake_minimum_required(VERSION 3.5)
project(ThermoPack LANGUAGES Fortran)

string(ASCII 27 Esc)
set(ColorRed "${Esc}[31m")
set(ColorBlue "${Esc}[34m")

if(NOT MSVC)
    execute_process(COMMAND bash -c "arch" OUTPUT_VARIABLE PROC)
    set(tp_flags_common "-cpp -fPIC -fdefault-real-8 -fdefault-double-8 -frecursive -fopenmp -Wno-unused-function -Wno-unused-variable")

    include(CheckCompilerFlag)
    check_compiler_flag(Fortran "-arch arm64" arm64_supported)
    if(arm64_supported)
        set(gf_proc "-arch arm64")
        set(gf_march "-arch arm64 -fno-expensive-optimizations")
    else()
        set(gf_proc "-mieee-fp")
        set(gf_march "-march=x86-64 -msse2")
    endif()

    set(tp_debug_flags "${gf_proc} ${tp_flags_common} -g -fbounds-check -fbacktrace -ffpe-trap=invalid,zero,overflow -Wno-unused-dummy-argument -Wall")
    set(tp_optim_flags "${tp_flags_common} -O3 ${gf_march} -funroll-loops")

    if(APPLE)
        set(CMAKE_FORTRAN_COMPILER /opt/homebrew/bin/gfortran)
        set(CMAKE_OSX_ARCHITECTURES "arm64" CACHE STRING "The OSX architecture")
    endif()
else()
    message(${ColorRed}"cmake not configured for windows!")
    return()
endif()

if(CMAKE_BUILD_TYPE MATCHES Debug)
    set(tp_fortran_flags ${tp_debug_flags})
else()
    set(tp_fortran_flags ${tp_optim_flags})
endif()

add_subdirectory(${CMAKE_CURRENT_SOURCE_DIR}/src "thermopack")

option(test "Build test suite" OFF)
if(test)
    cmake_policy(SET CMP0074 NEW)
    find_package(PFUNIT QUIET)
    if (NOT PFUNIT_FOUND)
        message("${ColorRed}Did not find pFUnit. If you have installed pFUnit, make sure that PFUNIT_DIR is set. Falling back to building pFUnit from source...")
        add_subdirectory(${CMAKE_CURRENT_SOURCE_DIR}/external/pFUnit)
    endif()
    message("${ColorBlue}Creating run_unittests target")
    add_subdirectory(${CMAKE_CURRENT_SOURCE_DIR}/unittests)
endif()